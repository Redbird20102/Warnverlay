<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather Warning Overlay</title>
  <!-- Load Bebas Neue font for warning text -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; }
    
    /* Overlay Container */
    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: -10;
      width: 120%;
      height: 120%;
      background-color: rgba(0,0,0,0);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
    }
    
    /* Warning Image */
    #overlay img {
      max-width: 120%;
      max-height: 120%;
      opacity: 1;
      transition: opacity 2s ease-in-out;
    }
    
    /* Base Text Container */
    .text-container {
      position: absolute;
      font-size: 2.6rem;
      font-weight: bold;
      font-family: 'Bebas Neue', sans-serif;
      text-align: center;
      opacity: 0;
      transition: opacity 2s ease-in-out;
    }
    
    /* ------------------ Severe Thunderstorm (Default) ------------------ */
    .severe#testWarningContainer {
      top: 73%; left: 64.5%;
      transform: translate(-50%,-50%);
      color: rgb(255,255,255);
    }
    .severe#testCountyContainer {
      top: 77%; left: 64.5%;
      transform: translate(-50%,-50%);
      color: rgb(255,255,255);
      font-size: 1.3rem;
    }
    .considerableSevere#testWarningContainer { color: rgb(255,255,255) !important; }
    .considerableSevere#testCountyContainer { color: rgb(255,255,255) !important; }
    .destructiveSevere#testWarningContainer { color: rgb(255,255,255) !important; }
    .destructiveSevere#testCountyContainer { color: rgb(255,255,255) !important; }
    
    /* ------------------ Flash Flood (Default) ------------------ */
    .flashFlood#testWarningContainer {
      top: 73%; left: 64.5%;
      transform: translate(-50%,-50%);
      color: rgb(255,255,255);
    }
    .flashFlood#testCountyContainer {
      top: 77%; left: 64.5%;
      transform: translate(-50%,-50%);
      color: rgb(255,255,255);
      font-size: 1.3rem;
    }
    .considerableFlashFlood#testWarningContainer { color: rgb(255,255,255) !important; }
    .considerableFlashFlood#testCountyContainer { color: rgb(255,255,255) !important; }
    .catastrophicFlashFlood#testWarningContainer { color: rgb(255,255,255) !important; }
    .catastrophicFlashFlood#testCountyContainer { color: rgb(255,255,255) !important; }
    
    /* ------------------ Tornado (Default) ------------------ */
    .tornado#testWarningContainer {
      top: 73%; left: 64.5%;
      transform: translate(-50%,-50%);
      color: rgb(255,255,255);
    }
    .tornado#testCountyContainer {
      top: 77%; left: 64.5%;
      transform: translate(-50%,-50%);
      color: rgb(255,255,255);
      font-size: 1.3rem;
    }
    .pdsTornado#testWarningContainer { color: rgb(255,255,255) !important; }
    .pdsTornado#testCountyContainer { color: rgb(255,255,255) !important; }
    .tornadoEmergency#testWarningContainer { color: rgb(255,255,255) !important; }
    .tornadoEmergency#testCountyContainer { color: rgb(255,255,255) !important; }
  </style>
</head>
<body>
  <!-- Overlay element to display warnings -->
  <div id="overlay">
    <img id="overlayImage" src="" alt="Warning Image">
    <audio id="overlayAudio"></audio>
    <div id="testWarningContainer" class="text-container severe"></div>
    <div id="testCountyContainer" class="text-container severe"></div>
  </div>
  
  <script>
    // Global alert queue and flag.
    let alertQueue = [];
    let isOverlayActive = false;
    
    // initialLoad prevents showing overlays on startup.
    let initialLoad = true;
    
    // These objects keep track of each issued alert per type.
    let issuedTornadoAlerts = {};
    let issuedSevereAlerts = {};
    let issuedFlashFloodAlerts = {};
    
    // Throttle tracking: last queued time per type.
    let lastQueuedTime = { tornado: 0, severe: 0, flashFlood: 0 };
    const throttleDelay = 15000;
    
    // Helper function to get text from the first matching tag.
    function getText(node, tagName) {
      return node.querySelector(tagName)?.textContent || "";
    }
    
    // Normalize area text.
    const normalizeArea = area => area.trim();
    
    // Generate a unique alert key.
    const generateAlertKey = (eventText, areaDesc) =>
      `${eventText.trim()}|${normalizeArea(areaDesc)}`;
      
    // Enqueue an alert if it isnâ€™t already in the queue.
    function enqueueAlert(options) {
      const type = options.type;
      const now = Date.now();
      if (now - lastQueuedTime[type] < throttleDelay) {
        console.log("Throttling alert of type", type, "for alert key", options.alertKey);
        return;
      }
      lastQueuedTime[type] = now;
      
      if (!alertQueue.some(alert => alert.alertKey === options.alertKey && alert.type === options.type)) {
        alertQueue.push(options);
      } else {
        console.log("Alert", options.alertKey, "of type", options.type, "already queued; skipping.");
      }
    }
    
    // Process the next alert in the queue, if any.
    function processNextAlert() {
      if (alertQueue.length === 0) return;
      isOverlayActive = true;
      const options = alertQueue.shift();
      triggerWarning(options);
    }
    
    // Show the overlay, play any audio, and apply proper classes.
    function triggerWarning(options) {
      const { imageSrc, audioSrc, eventText, areaDesc, type, pds, emergency, destructive, flashFloodConsiderable, flashFloodCatastrophic } = options;
      const overlay = document.getElementById("overlay");
      const overlayImage = document.getElementById("overlayImage");
      const overlayAudio = document.getElementById("overlayAudio");
      const testWarningContainer = document.getElementById("testWarningContainer");
      const testCountyContainer = document.getElementById("testCountyContainer");
      
      // Set CSS classes based on alert type.
      if (type === "tornado") {
        testWarningContainer.className = "text-container tornado";
        testCountyContainer.className = "text-container tornado";
        if (emergency) {
          testWarningContainer.classList.add("tornadoEmergency");
          testCountyContainer.classList.add("tornadoEmergency");
        } else if (pds) {
          testWarningContainer.classList.add("pdsTornado");
          testCountyContainer.classList.add("pdsTornado");
        } else {
          testWarningContainer.style.color = "rgb(255,255,255)";
          testCountyContainer.style.color  = "rgb(255,255,255)";
        }
      } else if (type === "flashFlood") {
        testWarningContainer.className = "text-container flashFlood";
        testCountyContainer.className = "text-container flashFlood";
        if (flashFloodCatastrophic) {
          testWarningContainer.classList.add("catastrophicFlashFlood");
          testCountyContainer.classList.add("catastrophicFlashFlood");
        } else if (flashFloodConsiderable) {
          testWarningContainer.classList.add("considerableFlashFlood");
          testCountyContainer.classList.add("considerableFlashFlood");
        } else {
          testWarningContainer.style.color = "rgb(255,255,255)";
          testCountyContainer.style.color  = "rgb(255,255,255)";
        }
      } else {
        // Severe Thunderstorm Warning.
        testWarningContainer.className = "text-container severe";
        testCountyContainer.className = "text-container severe";
        testWarningContainer.style.color = "rgb(255,255,255)";
        testCountyContainer.style.color  = "rgb(255,255,255)";
        testCountyContainer.style.fontSize = "1.3rem";
        if (destructive) {
          testWarningContainer.classList.add("destructiveSevere");
          testCountyContainer.classList.add("destructiveSevere");
        }
      }
      
      // Update the image with cache busting.
      overlayImage.src = imageSrc + "?t=" + new Date().getTime();
      overlayImage.style.transition = "none";
      overlayImage.style.opacity = "1";
      setTimeout(() => {
        overlayImage.style.transition = "opacity 2s ease-in-out";
      }, 50);
      
      // Play audio if provided.
      if (audioSrc) {
        overlayAudio.src = audioSrc;
        overlayAudio.play().catch(err => console.error("Audio playback error:", err));
      } else {
        overlayAudio.pause();
        overlayAudio.src = "";
      }
      
      // Set text for the overlay.
      testWarningContainer.textContent = eventText;
      testCountyContainer.textContent  = areaDesc;
      
      // Show the overlay.
      overlay.style.display = "flex";
      
      setTimeout(() => {
        testWarningContainer.style.opacity = "1";
        testCountyContainer.style.opacity = "1";
      }, 2000);
      
      setTimeout(() => {
        testWarningContainer.style.opacity = "0";
        testCountyContainer.style.opacity = "0";
      }, 16000);
      
      setTimeout(() => {
        overlayImage.style.opacity = "0";
      }, 18370);
      
      // After completion, hide overlay and reset the queued flag so that upgrades
      // can be queued later if the threat level changes.
      setTimeout(() => {
        overlay.style.display = "none";
        overlayImage.style.opacity = "1";
        isOverlayActive = false;
        switch(options.type) {
          case "tornado":
            if (issuedTornadoAlerts[options.alertKey]) {
              issuedTornadoAlerts[options.alertKey].queued = false;
            }
            break;
          case "severe":
            if (issuedSevereAlerts[options.alertKey]) {
              issuedSevereAlerts[options.alertKey].queued = false;
            }
            break;
          case "flashFlood":
            if (issuedFlashFloodAlerts[options.alertKey]) {
              issuedFlashFloodAlerts[options.alertKey].queued = false;
            }
            break;
        }
        processNextAlert();
      }, 19630);
    }
    
    // Main fetch function that polls NOAAâ€™s alert feed every 5 seconds.
    function fetchAlerts() {
      fetch("https://api.weather.gov/alerts/active.atom?urgency=Past%2CFuture%2CExpected%2CImmediate")
        .then(response => response.text())
        .then(str => {
          const parser = new DOMParser();
          const xml = parser.parseFromString(str, "application/xml");
          const entries = xml.getElementsByTagName("entry");
          if (!entries || entries.length === 0) return;
          
          // Keep track of alert keys seen this poll.
          const currentFeedKeys = new Set();
          
          for (let i = 0; i < entries.length; i++) {
            const entry = entries[i];
            const eventElem = entry.getElementsByTagName("cap:event")[0];
            const areaDescElem = entry.getElementsByTagName("cap:areaDesc")[0];
            if (!eventElem || !areaDescElem) continue;
            
            const eventTextRaw = eventElem.textContent.trim();
            const areaDesc = areaDescElem.textContent.trim();
            const parameters = Array.from(entry.getElementsByTagName("cap:parameter"));
            
            // ---- Severe Thunderstorm Warnings ----
            if (eventTextRaw.toLowerCase().includes("severe thunderstorm warning")) {
              // Use a constant key so that even if the text upgrades, the county is the same.
              const severeAlertKey = generateAlertKey("Severe Thunderstorm Warning", areaDesc);
              currentFeedKeys.add(severeAlertKey);
              
              const thunderstormDamageParam = parameters.find(param =>
                getText(param, "valueName") === "thunderstormDamageThreat"
              );
              const rawThreat = thunderstormDamageParam ? getText(thunderstormDamageParam, "value") : null;
              const normalizedThreat = rawThreat ? rawThreat.trim().toUpperCase() : "DEFAULT";
              let currentThreat = "DEFAULT";
              if (normalizedThreat === "DESTRUCTIVE") {
                currentThreat = "DESTRUCTIVE";
              } else if (normalizedThreat === "CONSIDERABLE") {
                currentThreat = "CONSIDERABLE";
              }
              
              if (initialLoad) {
                issuedSevereAlerts[severeAlertKey] = { state: currentThreat, queued: true };
              } else {
                let record = issuedSevereAlerts[severeAlertKey];
                if (!record) {
                  issuedSevereAlerts[severeAlertKey] = { state: currentThreat, queued: true };
                  let finalEventText, severeImage, severeAudio;
                  let destructive = false;
                  if (currentThreat === "DESTRUCTIVE") {
                    destructive = true;
                    finalEventText = "PDS Severe Thunderstorm Warning - Destructive";
                    severeImage = "PDS SVR.gif";
                    severeAudio = "PDS SVR.mp3";
                  } else if (currentThreat === "CONSIDERABLE") {
                    finalEventText = "Severe Thunderstorm Warning â€“ Considerable";
                    severeImage = "SVR - Considerable.gif";
                    severeAudio = "SVR.mp3";
                  } else {
                    finalEventText = "Severe Thunderstorm Warning";
                    severeImage = "SVR.gif";
                    severeAudio = "SVR.mp3";
                  }
                  console.log("Queuing severe thunderstorm overlay with text:", finalEventText);
                  enqueueAlert({
                    alertKey: severeAlertKey,
                    imageSrc: severeImage,
                    audioSrc: severeAudio,
                    eventText: finalEventText,
                    areaDesc: areaDesc,
                    type: "severe",
                    destructive: destructive
                  });
                } else if (record.state !== currentThreat && record.queued === false) {
                  record.state = currentThreat;
                  record.queued = true;
                  let finalEventText, severeImage, severeAudio;
                  let destructive = false;
                  if (currentThreat === "DESTRUCTIVE") {
                    destructive = true;
                    finalEventText = "PDS Severe Thunderstorm Warning - Destructive Upgraded";
                    severeImage = "PDS SVR.gif";
                    severeAudio = "PDS SVR.mp3";
                  } else if (currentThreat === "CONSIDERABLE") {
                    finalEventText = "Severe Thunderstorm Warning â€“ Considerable Upgraded";
                    severeImage = "SVR - Considerable.gif";
                    severeAudio = "SVR.mp3";
                  } else {
                    finalEventText = "Severe Thunderstorm Warning";
                    severeImage = "SVR.gif";
                    severeAudio = "SVR.mp3";
                  }
                  console.log("Queuing severe thunderstorm overlay with text:", finalEventText);
                  enqueueAlert({
                    alertKey: severeAlertKey,
                    imageSrc: severeImage,
                    audioSrc: severeAudio,
                    eventText: finalEventText,
                    areaDesc: areaDesc,
                    type: "severe",
                    destructive: destructive
                  });
                } else {
                  console.log("Severe thunderstorm alert", severeAlertKey, "already recorded with same stateâ€”skipping.");
                }
              }
            }
            // ---- Tornado Warnings ----
            else if (eventTextRaw.toLowerCase().includes("tornado warning")) {
              // Use a constant key for tornado alerts.
              const tornadoAlertKey = generateAlertKey("Tornado Warning", areaDesc);
              currentFeedKeys.add(tornadoAlertKey);
              
              const tornadoDamageParam = parameters.find(param =>
                getText(param, "valueName") === "tornadoDamageThreat"
              );
              const rawTornadoDamageThreat = tornadoDamageParam ? getText(tornadoDamageParam, "value") : "DEFAULT";
              const normalizedTornadoDamageThreat = rawTornadoDamageThreat.trim().toUpperCase();
              
              const tornadoDetectionParam = parameters.find(param =>
                getText(param, "valueName") === "tornadoDetection"
              );
              const rawTornadoDetection = tornadoDetectionParam ? getText(tornadoDetectionParam, "value") : "";
              const normalizedTornadoDetection = rawTornadoDetection.trim().toUpperCase();
              
              let currentState = "DEFAULT";
              if (normalizedTornadoDamageThreat === "CATASTROPHIC") {
                currentState = "EMERGENCY";
              } else if (((normalizedTornadoDetection === "OBSERVED" ||
                           normalizedTornadoDetection.includes("RADAR INDICATED")) &&
                          normalizedTornadoDamageThreat === "CONSIDERABLE")) {
                currentState = "PDS";
              } else if (normalizedTornadoDetection === "OBSERVED") {
                currentState = "OBSERVED";
              }
              
              if (initialLoad) {
                issuedTornadoAlerts[tornadoAlertKey] = { state: currentState, queued: true };
              } else {
                let record = issuedTornadoAlerts[tornadoAlertKey];
                if (!record) {
                  issuedTornadoAlerts[tornadoAlertKey] = { state: currentState, queued: true };
                  let finalAlertText, finalAudio, finalImage;
                  let pds = false, emergencyFlag = false;
                  if (currentState === "EMERGENCY") {
                    emergencyFlag = true;
                    finalAlertText = "Tornado Emergency";
                    finalAudio = "TORE.mp3";
                    finalImage = "TORE.gif";
                  } else if (currentState === "PDS") {
                    pds = true;
                    finalAlertText = "PDS Tornado Warning";
                    finalAudio = "PDS TOR.mp3";
                    finalImage = "PDS TOR.gif";
                  } else if (currentState === "OBSERVED") {
                    finalAlertText = "Observed Tornado Warning";
                    finalAudio = "TOR.mp3";
                    finalImage = "TOR.gif";
                  } else {
                    finalAlertText = "Tornado Warning";
                    finalAudio = "TOR.mp3";
                    finalImage = "TOR.gif";
                  }
                  console.log("Queuing tornado overlay with text:", finalAlertText);
                  enqueueAlert({
                    alertKey: tornadoAlertKey,
                    imageSrc: finalImage,
                    audioSrc: finalAudio,
                    eventText: finalAlertText,
                    areaDesc: areaDesc,
                    type: "tornado",
                    pds: pds,
                    emergency: emergencyFlag
                  });
                } else if (record.state !== currentState && record.queued === false) {
                  record.state = currentState;
                  record.queued = true;
                  let finalAlertText, finalAudio, finalImage;
                  let pds = false, emergencyFlag = false;
                  if (currentState === "EMERGENCY") {
                    emergencyFlag = true;
                    finalAlertText = "Tornado Emergency Upgraded";
                    finalAudio = "TORE Upgraded.mp3";
                    finalImage = "TORE.gif";
                  } else if (currentState === "PDS") {
                    pds = true;
                    finalAlertText = "PDS Tornado Warning Upgraded";
                    finalAudio = "PDS TOR - TOR Upgraded.mp3";
                    finalImage = "PDS TOR.gif";
                  } else if (currentState === "OBSERVED") {
                    finalAlertText = "Observed Tornado Warning Upgraded";
                    finalAudio = "PDS TOR - TOR Upgraded.mp3";
                    finalImage = "TOR.gif";
                  } else {
                    finalAlertText = "Tornado Warning";
                    finalAudio = "TOR.mp3";
                    finalImage = "TOR.gif";
                  }
                  console.log("Queuing tornado overlay with text:", finalAlertText);
                  enqueueAlert({
                    alertKey: tornadoAlertKey,
                    imageSrc: finalImage,
                    audioSrc: finalAudio,
                    eventText: finalAlertText,
                    areaDesc: areaDesc,
                    type: "tornado",
                    pds: pds,
                    emergency: emergencyFlag
                  });
                } else {
                  console.log("Tornado alert", tornadoAlertKey, "already recorded with same stateâ€”skipping.");
                }
              }
            }
            // ---- Flash Flood Warnings ----
            else if (eventTextRaw.toLowerCase().includes("flash flood warning")) {
              // Use a constant key for flash flood alerts.
              const ffwKey = generateAlertKey("Flash Flood Warning", areaDesc);
              currentFeedKeys.add(ffwKey);
              
              const flashFloodParam = parameters.find(param =>
                getText(param, "valueName") === "flashFloodDamageThreat"
              );
              const rawFlashFloodDamageThreat = flashFloodParam ? getText(flashFloodParam, "value") : "DEFAULT";
              const normalizedFlashFloodDamageThreat = rawFlashFloodDamageThreat.trim().toUpperCase();
              
              let currentFFThreat = "DEFAULT";
              if (normalizedFlashFloodDamageThreat === "CATASTROPHIC")
                currentFFThreat = "CATASTROPHIC";
              else if (normalizedFlashFloodDamageThreat === "CONSIDERABLE")
                currentFFThreat = "CONSIDERABLE";
              
              if (initialLoad) {
                issuedFlashFloodAlerts[ffwKey] = { state: currentFFThreat, queued: true };
              } else {
                let record = issuedFlashFloodAlerts[ffwKey];
                if (!record) {
                  issuedFlashFloodAlerts[ffwKey] = { state: currentFFThreat, queued: true };
                  let finalEventText, finalImage, finalAudio;
                  if (currentFFThreat === "CATASTROPHIC") {
                    finalEventText = "Flash Flood Emergency";
                    finalImage = "FFWE.gif";
                    finalAudio = "FFWE.mp3";
                  } else if (currentFFThreat === "CONSIDERABLE") {
                    finalEventText = "Flash Flood Warning - Considerable";
                    finalImage = "FFW - Considerable.gif";
                    finalAudio = "FFW - Considerable.mp3";
                  } else {
                    finalEventText = "Flash Flood Warning";
                    finalImage = "FFW.gif";
                    finalAudio = "FFW.mp3";
                  }
                  console.log("Queuing flash flood overlay with text:", finalEventText);
                  enqueueAlert({
                    alertKey: ffwKey,
                    imageSrc: finalImage,
                    audioSrc: finalAudio,
                    eventText: finalEventText,
                    areaDesc: areaDesc,
                    type: "flashFlood",
                    flashFloodConsiderable: currentFFThreat === "CONSIDERABLE",
                    flashFloodCatastrophic: currentFFThreat === "CATASTROPHIC"
                  });
                } else if (record.state !== currentFFThreat && record.queued === false && currentFFThreat !== "DEFAULT") {
                  record.state = currentFFThreat;
                  record.queued = true;
                  let finalEventText, finalImage, finalAudio;
                  if (currentFFThreat === "CATASTROPHIC") {
                    finalEventText = "Flash Flood Emergency Upgraded";
                    finalImage = "FFWE.gif";
                    finalAudio = "FFWE Upgraded.mp3";
                  } else if (currentFFThreat === "CONSIDERABLE") {
                    finalEventText = "Flash Flood Warning - Considerable Upgraded";
                    finalImage = "FFW - Considerable.gif";
                    finalAudio = "FFW - Considerable Upgraded.mp3";
                  }
                  console.log("Queuing flash flood overlay with text:", finalEventText);
                  enqueueAlert({
                    alertKey: ffwKey,
                    imageSrc: finalImage,
                    audioSrc: finalAudio,
                    eventText: finalEventText,
                    areaDesc: areaDesc,
                    type: "flashFlood",
                    flashFloodConsiderable: currentFFThreat === "CONSIDERABLE",
                    flashFloodCatastrophic: currentFFThreat === "CATASTROPHIC"
                  });
                } else {
                  console.log("Flash flood alert", ffwKey, "already recorded with same stateâ€”skipping.");
                }
              }
            }
          } // End for-loop through entries.
          
          // Cleanup: Remove any keys no longer in the current feed.
          for (let key in issuedTornadoAlerts) {
            if (!currentFeedKeys.has(key)) delete issuedTornadoAlerts[key];
          }
          for (let key in issuedSevereAlerts) {
            if (!currentFeedKeys.has(key)) delete issuedSevereAlerts[key];
          }
          for (let key in issuedFlashFloodAlerts) {
            if (!currentFeedKeys.has(key)) delete issuedFlashFloodAlerts[key];
          }
          
          if (!initialLoad && !isOverlayActive && alertQueue.length > 0) {
            processNextAlert();
          }
          
          if (initialLoad) {
            console.log("Initial load complete. Active alerts recorded without overlaying.");
            initialLoad = false;
          }
        })
        .catch(err => console.error("Failed to fetch alerts:", err));
    }
    
    // Poll NOAA's alert feed every 1 seconds.
    setInterval(fetchAlerts, 1000);
  </script>
</body>
</html>
