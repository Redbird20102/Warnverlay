<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Weather Warning Overlay</title>
  <!-- Load Bebas Neue font for warning text -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; }
    
    /* Overlay Container */
    #overlay {
      display: none;
      position: fixed;
      top: 0; left: -10%;
      width: 120%; height: 120%;
      background-color: rgba(0, 0, 0, 0);
      justify-content: center;
      align-items: center;
      flex-direction: column;
      z-index: 9999;
    }
    
    /* Warning Image */
    #overlay img {
      max-width: 120%; max-height: 120%;
      opacity: 1;
      transition: opacity 2s ease-in-out;
    }
    
    /* Base Text Container */
    .text-container {
      position: absolute;
      font-size: 2.6rem;
      font-weight: bold;
      font-family: 'Bebas Neue', sans-serif;
      text-align: center;
      opacity: 0;
      transition: opacity 2s ease-in-out;
    }
    
    /* ------------------ Severe Thunderstorm (Default) ------------------ */
    .severe#testWarningContainer {
      top: 73%; left: 64.5%; transform: translate(-50%, -50%);
      color: rgb(255, 255, 255);
    }
    .severe#testCountyContainer {
      top: 77%; left: 64.5%; transform: translate(-50%, -50%);
      color: rgb(255, 255, 255);
      font-size: 1.7rem;
    }
    .considerableSevere#testWarningContainer { color: rgb(255, 255, 255) !important; }
    .considerableSevere#testCountyContainer { color: rgb(255, 255, 255) !important; }
    .destructiveSevere#testWarningContainer { color: rgb(255, 255, 255) !important; }
    .destructiveSevere#testCountyContainer { color: rgb(255, 255, 255) !important; }
    
    /* ------------------ Flash Flood (Default) ------------------ */
    .flashFlood#testWarningContainer {
      top: 73%; left: 64.5%; transform: translate(-50%, -50%);
      color: rgb(255, 255, 255);
    }
    .flashFlood#testCountyContainer {
      top: 77%; left: 64.5%; transform: translate(-50%, -50%);
      color: rgb(255, 255, 255);
      font-size: 1.7rem;
    }
    .considerableFlashFlood#testWarningContainer { color: rgb(255, 255, 255) !important; }
    .considerableFlashFlood#testCountyContainer { color: rgb(255, 255, 255) !important; }
    /* Catastrophic Flash Flood is displayed as “Emergency” */
    .catastrophicFlashFlood#testWarningContainer { color: rgb(255, 255, 255) !important; }
    .catastrophicFlashFlood#testCountyContainer { color: rgb(255, 255, 255) !important; }
    
    /* ------------------ Tornado (Default) ------------------ */
    .tornado#testWarningContainer {
      top: 73%; left: 64.5%; transform: translate(-50%, -50%);
      color: rgb(255, 255, 255);
    }
    .tornado#testCountyContainer {
      top: 77%; left: 64.5%; transform: translate(-50%, -50%);
      color: rgb(255, 255, 255);
      font-size: 1.7rem;
    }
    .pdsTornado#testWarningContainer { color: rgb(255, 255, 255) !important; }
    .pdsTornado#testCountyContainer { color: rgb(255, 255, 255) !important; }
    .tornadoEmergency#testWarningContainer { color: rgb(255, 255, 255) !important; }
    .tornadoEmergency#testCountyContainer { color: rgb(255, 255, 255) !important; }
  </style>
</head>
<body>
  <div id="overlay">
    <img id="overlayImage" src="" alt="Warning Image" />
    <audio id="overlayAudio"></audio>
    <div id="testWarningContainer" class="text-container severe"></div>
    <div id="testCountyContainer" class="text-container severe"></div>
  </div>
  
  <script>
    // Helper function to get the text content of the first matching element.
    function getText(node, tagName) {
      return node.querySelector(tagName)?.textContent || "";
    }
    
    // Persistent objects for active alerts.
    // Each key (generated by eventText + areaDesc) stores the current state.
    // For tornado: state can be "OBSERVED", "PDS", "EMERGENCY", "DEFAULT"
    // For severe: state can be "CONSIDERABLE", "DESTRUCTIVE", "DEFAULT"
    // For flash flood: state can be "CONSIDERABLE", "CATASTROPHIC", "DEFAULT"
    const activeTornadoAlerts = {};
    const activeSevereAlerts = {};
    const activeFlashFloodAlerts = {};

    // Utility functions.
    const normalizeArea = area => area.trim();
    const generateAlertKey = (eventText, areaDesc) =>
      `${eventText.trim()}|${normalizeArea(areaDesc)}`;
    
    /**
     * triggerWarning – displays the overlay.
     * @param {object} options - Contains display properties and an alertKey.
     */
    function triggerWarning(options) {
      // If the overlay is currently visible, do nothing.
      if (document.getElementById("overlay").style.display === "flex") return;
      
      const { imageSrc, audioSrc, eventText, areaDesc, type, pds, emergency, destructive, considerable, flashFloodCatastrophic, alertKey } = options;
      const overlay        = document.getElementById("overlay");
      const overlayImage   = document.getElementById("overlayImage");
      const overlayAudio   = document.getElementById("overlayAudio");
      const testWarningContainer = document.getElementById("testWarningContainer");
      const testCountyContainer  = document.getElementById("testCountyContainer");
      
      // Set CSS classes based on the alert type and flags.
      if (type === "tornado") {
        testWarningContainer.className = "text-container tornado";
        testCountyContainer.className  = "text-container tornado";
        if (emergency) {
          testWarningContainer.classList.add("tornadoEmergency");
          testCountyContainer.classList.add("tornadoEmergency");
        } else if (pds) {
          testWarningContainer.classList.add("pdsTornado");
          testCountyContainer.classList.add("pdsTornado");
        } else {
          testWarningContainer.style.color = "rgb(255, 255, 255)";
          testCountyContainer.style.color  = "rgb(255, 255, 255)";
        }
      } else if (type === "flashFlood") {
        testWarningContainer.className = "text-container flashFlood";
        testCountyContainer.className  = "text-container flashFlood";
        if (flashFloodCatastrophic) {
          testWarningContainer.classList.add("catastrophicFlashFlood");
          testCountyContainer.classList.add("catastrophicFlashFlood");
        } else if (options.flashFloodConsiderable) {
          testWarningContainer.classList.add("considerableFlashFlood");
          testCountyContainer.classList.add("considerableFlashFlood");
        } else {
          testWarningContainer.style.color = "rgb(255, 255, 255)";
          testCountyContainer.style.color  = "rgb(255, 255, 255)";
        }
      } else {  // severe thunderstorm
        testWarningContainer.className = "text-container severe";
        testCountyContainer.className  = "text-container severe";
        testWarningContainer.style.color = "rgb(255, 255, 255)";
        testCountyContainer.style.color  = "rgb(255, 255, 255)";
        testCountyContainer.style.fontSize = "1.3rem";
        if (destructive) {
          testWarningContainer.classList.add("destructiveSevere");
          testCountyContainer.classList.add("destructiveSevere");
        } else if (considerable) {
          testWarningContainer.classList.add("considerableSevere");
          testCountyContainer.classList.add("considerableSevere");
        }
      }
      
      overlayImage.src = imageSrc + "?t=" + new Date().getTime();
      overlayImage.style.opacity = "1";
      if (audioSrc) {
        overlayAudio.src = audioSrc;
        overlayAudio.play().catch(err => console.error("Audio playback error:", err));
      } else {
        overlayAudio.pause();
        overlayAudio.src = "";
      }
      
      testWarningContainer.textContent = eventText;
      testCountyContainer.textContent  = areaDesc;
      overlay.style.display = "flex";
      
      setTimeout(() => {
        testWarningContainer.style.opacity = "1";
        testCountyContainer.style.opacity  = "1";
      }, 2000);
      setTimeout(() => {
        testWarningContainer.style.opacity = "0";
        testCountyContainer.style.opacity  = "0";
      }, 16000);
      setTimeout(() => { overlayImage.style.opacity = "0"; }, 18370);
      setTimeout(() => {
        overlay.style.display = "none";
        overlayImage.style.opacity = "1";
        // (We do not clear the persistent state here so that future state changes can trigger overlays.)
      }, 18730);
    }
    
    // Poll the alerts feed every 5 seconds.
    function fetchAlerts() {
      fetch("https://api.weather.gov/alerts/active.atom?urgency=Past%2CFuture%2CExpected%2CImmediate")
        .then(response => response.text())
        .then(str => {
          const parser = new DOMParser();
          const xml = parser.parseFromString(str, "application/xml");
          const entries = xml.getElementsByTagName("entry");
          if (!entries || entries.length === 0) return;
          
          // Process one alert per poll.
          for (let i = 0; i < entries.length; i++) {
            const entry = entries[i];
            const eventElem = entry.getElementsByTagName("cap:event")[0];
            const areaDescElem = entry.getElementsByTagName("cap:areaDesc")[0];
            if (!eventElem || !areaDescElem) continue;
            const eventTextRaw = eventElem.textContent.trim();
            const areaDesc = areaDescElem.textContent.trim();
            const parameters = Array.from(entry.getElementsByTagName("cap:parameter"));
            
            // ----- Tornado Warnings -----
            if (eventTextRaw.toLowerCase().includes("tornado warning")) {
              // Extract parameters:
              const tornadoDetection = parameters.find(param =>
                getText(param, "valueName") === "tornadoDetection"
              ) ? getText(parameters.find(param =>
                getText(param, "valueName") === "tornadoDetection"), "value") : null;
              const tornadoDetectionObserved = tornadoDetection === "OBSERVED";
              const tornadoDamageThreat = parameters.find(param =>
                getText(param, "valueName") === "tornadoDamageThreat"
              ) ? getText(parameters.find(param =>
                getText(param, "valueName") === "tornadoDamageThreat"), "value") : null;
              
              // Determine current state.
              let currentState = "DEFAULT";
              if (tornadoDetectionObserved) currentState = "OBSERVED";
              else if (tornadoDamageThreat === "CONSIDERABLE") currentState = "PDS";
              else if (tornadoDamageThreat === "CATASTROPHIC") currentState = "EMERGENCY";
              
              const alertKey = generateAlertKey(eventTextRaw, areaDesc);
              
              // If already active with same state, skip overlay.
              if (activeTornadoAlerts[alertKey] === currentState) continue;
              
              // Determine final text based on whether this is new or an upgrade.
              let finalAlertText = "";
              let finalAudio = "TOR.mp3";
              let finalImage = "TOR.gif";
              let pds = false, emergencyFlag = false;
              
              if (tornadoDetectionObserved) {
                if (!activeTornadoAlerts[alertKey]) {
                  finalAlertText = "Observed Tornado Warning";
                } else {
                  finalAlertText = "Observed Tornado Warning Upgraded";
                  finalAudio = "PDS TOR - TOR Upgraded.mp3";
                }
              } else if (tornadoDetection && tornadoDetection.includes("RADAR INDICATED")) {
                if (!activeTornadoAlerts[alertKey]) {
                  finalAlertText = "Tornado Warning";
                } else {
                  continue;
                }
              } else if (tornadoDamageThreat === "CONSIDERABLE") {
                pds = true;
                if (!activeTornadoAlerts[alertKey]) {
                  finalAlertText = "PDS Tornado Warning";
                } else {
                  finalAlertText = "PDS Tornado Warning Upgraded";
                  finalAudio = "PDS TOR - TOR Upgraded.mp3";
                  finalImage = "PDS_TOR.gif";
                }
              } else if (tornadoDamageThreat === "CATASTROPHIC") {
                emergencyFlag = true;
                if (!activeTornadoAlerts[alertKey]) {
                  finalAlertText = "Tornado Emergency";
                } else {
                  finalAlertText = "Tornado Emergency Upgraded";
                  finalAudio = "TORE Upgraded.mp3";
                  finalImage = "TORE.gif";
                }
              } else {
                finalAlertText = eventTextRaw;
              }
              // Update persistent state.
              activeTornadoAlerts[alertKey] = currentState;
              
              triggerWarning({
                alertKey: alertKey,
                imageSrc: finalImage,
                audioSrc: finalAudio,
                eventText: finalAlertText,
                areaDesc: areaDesc,
                type: "tornado",
                pds: pds,
                emergency: emergencyFlag
              });
              break;
            }
            
            // ----- Severe Thunderstorm Warnings -----
            else if (eventTextRaw.toLowerCase().includes("severe thunderstorm warning")) {
              const thunderstormDamageThreat = parameters.find(param =>
                getText(param, "valueName") === "thunderstormDamageThreat"
              ) ? getText(parameters.find(param =>
                getText(param, "valueName") === "thunderstormDamageThreat"), "value") : null;
              let currentThreat = "DEFAULT";
              if (thunderstormDamageThreat === "CONSIDERABLE") currentThreat = "CONSIDERABLE";
              else if (thunderstormDamageThreat === "DESTRUCTIVE") currentThreat = "DESTRUCTIVE";
              
              const severeAlertKey = generateAlertKey("Severe Thunderstorm Warning", areaDesc);
              if (activeSevereAlerts[severeAlertKey] === currentThreat) continue;
              
              let finalEventText = "";
              let destructive = false;
              let severeImage = "SVR.gif";
              let severeAudio = "SVR.mp3";
              if (currentThreat === "CONSIDERABLE") {
                finalEventText = activeSevereAlerts[severeAlertKey] ? 
                                  "Severe Thunderstorm Warning - Considerable Upgraded" :
                                  "Severe Thunderstorm Warning - Considerable";
                severeImage = "SVR - Considerable.gif";
              } else if (currentThreat === "DESTRUCTIVE") {
                destructive = true;
                finalEventText = activeSevereAlerts[severeAlertKey] ?
                                  "PDS Severe Thunderstorm Warning - Destructive Upgraded" :
                                  "PDS Severe Thunderstorm Warning - Destructive";
                severeImage = "PDS SVR.gif";
                severeAudio = "PDS SVR.mp3";
              } else {
                finalEventText = "Severe Thunderstorm Warning";
              }
              activeSevereAlerts[severeAlertKey] = currentThreat;
              
              triggerWarning({
                alertKey: severeAlertKey,
                imageSrc: severeImage,
                audioSrc: severeAudio,
                eventText: finalEventText,
                areaDesc: areaDesc,
                type: "severe",
                destructive: destructive,
                considerable: currentThreat === "CONSIDERABLE"
              });
              break;
            }
            
            // ----- Flash Flood Warnings -----
            else if (eventTextRaw.toLowerCase().includes("flash flood warning")) {
              const ffwKey = generateAlertKey(eventTextRaw, areaDesc);
              const flashFloodDamageThreat = parameters.find(param =>
                getText(param, "valueName") === "flashFloodDamageThreat"
              ) ? getText(parameters.find(param =>
                getText(param, "valueName") === "flashFloodDamageThreat"), "value") : null;
              let currentFFThreat = "DEFAULT";
              if (flashFloodDamageThreat === "CONSIDERABLE") currentFFThreat = "CONSIDERABLE";
              else if (flashFloodDamageThreat === "CATASTROPHIC") currentFFThreat = "CATASTROPHIC";
              
              if (activeFlashFloodAlerts[ffwKey] === currentFFThreat) continue;
              
              let finalEventText = "";
              let finalImage = "FFW.gif";
              let finalAudio = "FFW.mp3";
              if (currentFFThreat === "CONSIDERABLE") {
                finalEventText = !activeFlashFloodAlerts[ffwKey] ?
                    "Flash Flood Warning - Considerable" :
                    "Flash Flood Warning - Considerable Upgraded";
                finalImage = "FFW - Considerable.gif";
                finalAudio = !activeFlashFloodAlerts[ffwKey] ?
                    "FFW - Considerable.mp3" :
                    "FFW - Considerable Upgraded.mp3";
              } else if (currentFFThreat === "CATASTROPHIC") {
                finalEventText = !activeFlashFloodAlerts[ffwKey] ?
                    "Flash Flood Emergency" :
                    "Flash Flood Emergency Upgraded";
                finalImage = "FFWE.gif";
                finalAudio = !activeFlashFloodAlerts[ffwKey] ?
                    "FFWE.mp3" :
                    "FFWE Upgraded.mp3";
              } else {
                finalEventText = "Flash Flood Warning";
              }
              activeFlashFloodAlerts[ffwKey] = currentFFThreat;
              
              triggerWarning({
                alertKey: ffwKey,
                imageSrc: finalImage,
                audioSrc: finalAudio,
                eventText: finalEventText,
                areaDesc: areaDesc,
                type: "flashFlood",
                flashFloodConsiderable: currentFFThreat === "CONSIDERABLE",
                flashFloodCatastrophic: currentFFThreat === "CATASTROPHIC"
              });
              break;
            }
          }
        })
        .catch(err => console.error("Failed to fetch alerts:", err));
    }
    
    setInterval(fetchAlerts, 5000);
    fetchAlerts();
  </script>
</body>
</html>
